{% extends "base.html" %}

{% block title %}Pull {{ pull_name }} â€“ {{ pull.team.team_name }}{% endblock %}

{% block extra_head %}
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_styles %}
  .pull-page-header {
    margin-bottom: 1.5rem;
  }

  .pull-page-header h1 {
    margin: 0 0 0.25rem;
  }

  .pull-meta {
    font-size: 0.9rem;
    color: #9ca3af;
    margin-bottom: 1rem;
  }

  .chart-card {
    background: #0f172a;
    border-radius: 0.75rem;
    padding: 1rem;
    box-shadow: 0 10px 30px rgba(15,23,42,0.8);
    margin-bottom: 1.25rem;
  }

  .chart-card h2 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
  }

  .chart-card canvas {
    max-width: 100%;
    height: 400px;
  }
{% endblock %}

{% block content %}
  <header class="pull-page-header">
    <h1>{{ pull_name }}</h1>
    <div class="pull-meta">
      Team: <strong>{{ pull.team.team_name }}</strong> ({{ pull.team.team_number }})<br>
      Final distance: {{ pull.final_distance|default:"N/A" }} ft<br>
      Hook : {{ pull.hook.hook_name|default:"N/A" }}
    </div>
  </header>
{%for vid in yt_embed%}
  <iframe width="1000" height="500" src="https://www.youtube.com/embed/{{vid.link}}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
{%endfor%}

  {% if photos %}
  <section class="chart-card">
    <h2>Photos</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
      {% for photo in photos %}
        <div style="border: 1px solid #1f2937; border-radius: 0.5rem; overflow: hidden; background: #020617;">
          <img src="/static/{{ photo.link }}" alt="{{ photo.caption|default:'Pull photo' }}" style="width: 100%; height: 200px; object-fit: cover; display: block;">
          {% if photo.caption %}
            <div style="padding: 0.5rem 0.75rem; font-size: 0.85rem; color: #9ca3af;">{{ photo.caption }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}



  <!-- 1) Speed vs Distance -->
  <section class="chart-card">
    <h2>Speed vs Distance (mph vs ft)</h2>
    {% if has_data %}
      <canvas id="speedDistanceChart"></canvas>
    {% else %}
      <p>No pull data available for this pull.</p>
    {% endif %}
  </section>

  <!-- 2) Chain Force vs Distance -->
  <section class="chart-card">
    <h2>Chain Force vs Distance (lbf vs ft)</h2>
    {% if has_data %}
      <canvas id="cfDistanceChart"></canvas>
    {% else %}
      <p>No pull data available for this pull.</p>
    {% endif %}
  </section>

  <!-- 3) Chain Force vs Speed -->
  <section class="chart-card">
    <h2>Chain Force vs Speed (lbf vs mph)</h2>
    {% if has_data %}
      <canvas id="cfSpeedChart"></canvas>
    {% else %}
      <p>No pull data available for this pull.</p>
    {% endif %}
  </section>
  <section class="chart-card">
  <h2>Upload Photo</h2>
  <form method="post" action="{% url 'events:upload_pull_photo' pull.pull_id %}" enctype="multipart/form-data">
    {% csrf_token %}
    <div style="display: grid; gap: 0.75rem;">
      <div>
        <input type="file" name="photo" accept="image/*"
                style="padding: 0.4rem; border: 1px solid #1f2937; border-radius: 0.5rem; background: #020617; color: #F3F6E7; font-size: 0.9rem; width: 100%;">
      </div>
      <div>
        <label style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 0.25rem; display: block;">Caption (optional)</label>
        <input type="text" name="photo_caption" maxlength="255" placeholder="Add a caption for this photo..."
                style="padding: 0.4rem 0.75rem; border: 1px solid #1f2937; border-radius: 0.5rem; background: #020617; color: #F3F6E7; font-size: 0.85rem; width: 100%;">
      </div>
      <div style="font-size: 0.8rem; color: #9ca3af;">Supported formats: PNG, JPG, JPEG, GIF, WebP.</div>
      <div>
        <button type="submit"
                style="padding: 0.45rem 1rem; border-radius: 999px; border: 1px solid #1f2937; background: #22c55e; color: #020617; cursor: pointer;">
          Upload
        </button>
      </div>
    </div>
  </form>
</section>
<p><a href="{% url 'events:pull_export' %}">Download Pull Data</a></p>
{% endblock %}

{% block extra_scripts %}
  {% if has_data %}
  <script>
    const speeds = {{ speeds_json|safe }};      // mph
    const forces = {{ forces_json|safe }};      // lbf
    const distances = {{ distances_json|safe }}; // ft

    // -------- 1) Speed vs Distance (mph vs ft) --------
    const speedDistancePoints = distances.map((d, i) => ({
      x: d,
      y: speeds[i]
    }));

    new Chart(document.getElementById('speedDistanceChart'), {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Speed (mph) vs Distance (ft)',
          data: speedDistancePoints,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Distance (ft)' } },
          y: { title: { display: true, text: 'Speed (mph)' } }
        }
      }
    });

    // -------- 2) Chain Force vs Distance (lbf vs ft) --------
    const cfDistancePoints = distances.map((d, i) => ({
      x: d,
      y: forces[i]
    }));

    new Chart(document.getElementById('cfDistanceChart'), {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Chain Force (lbf) vs Distance (ft)',
          data: cfDistancePoints,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Distance (ft)' } },
          y: { title: { display: true, text: 'Chain Force (lbf)' } }
        }
      }
    });

    // -------- 3) Chain Force vs Speed (lbf vs mph) --------
    const cfSpeedPoints = speeds.map((s, i) => ({
      x: s,
      y: forces[i]
    }));

    new Chart(document.getElementById('cfSpeedChart'), {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Chain Force (lbf) vs Speed (mph)',
          data: cfSpeedPoints,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'Speed (mph)' } },
          y: { title: { display: true, text: 'Chain Force (lbf)' } }
        }
      }
    });

  </script>
  
  {% endif %}
{% endblock %}
